version: 0.2

# Buildspec for running E2E tests in parallel. Test data is generated by buildspec.testdata.yml. Testreports are collected in
# a S3 bucket.

env:
  parameter-store:
    CYPRESS_baseUrl: CognitoFrontendApplicationUrl
    CYPRESS_AWS_USER_POOL_ID: CognitoUserPoolId
    CYPRESS_AWS_CLIENT_ID: /test/CognitoTestClient$RUNNER
    CYPRESS_REACT_APP_URL: /NVA/ApplicationDomain
    CYPRESS_REACT_APP_API_HOST: /NVA/ApiDomain
  secrets-manager:
    CYPRESS_DASHBOARD_KEY: 'E2ECypressDashboardKey:CypressDashboardKey'
  variables:
    image: public.ecr.aws/cypress-io/cypress/browsers:node14.17.0-chrome88-ff89

phases:
  install:
    runtime-versions:
      nodejs: latest
  pre_build:
    commands:
      - wget https://github.com/BIBSYSDEV/NVA-end-to-end-testing/archive/refs/heads/test-deploy.zip
      - unzip test-deploy.zip
      - cd NVA-end-to-end-testing-test-deploy
      - npm install
      - aws sts assume-role --role-arn $ROLE_ARN --role-session-name test > Credentials
      - export CYPRESS_AWS_ACCESS_KEY_ID=$(cat Credentials | jq -r '.Credentials.AccessKeyId')
      - export CYPRESS_AWS_SECRET_ACCESS_KEY=$(cat Credentials | jq -r '.Credentials.SecretAccessKey')
      - export CYPRESS_AWS_SESSION_TOKEN=$(cat Credentials | jq -r '.Credentials.SessionToken')
      - export CYPRESS_AWS_REGION=${AWS_REGION}
  build:
    commands:
      - npx cypress run --browser chrome  --record --key $CYPRESS_DASHBOARD_KEY --parallel --ci-build-id $CODEBUILD_INITIATOR
  post_build:
    commands:
      - export SECRET_STRING=$(aws secretsmanager get-secret-value --secret-id XrayApiKey | jq -r .SecretString)
      - export CLIENT_ID=$(echo $SECRET_STRING | jq -r .XrayClientId)
      - export CLIENT_SECRET=$(echo $SECRET_STRING | jq -r .XrayClientSecret)
      - 'export AUTH_BODY=''{"client_id": "''$CLIENT_ID''", "client_secret": "''$CLIENT_SECRET''"}'''
      - export BEARER_TOKEN=$(curl -H "Content-Type:application/json" -X POST --data "$AUTH_BODY" https://xray.cloud.getxray.app/api/v2/authenticate | tr -d '"')
      - for f in cypress/cucumber-json/*; do curl -H "Content-Type:application/json" -X POST -H "Authorization:Bearer $BEARER_TOKEN"  --data @"$f" https://xray.cloud.getxray.app/api/v2/import/execution/cucumber; done
      - if [ -d "cypress/cucumber-json" ]; then aws s3 cp cypress/cucumber-json s3://$TESTREPORTS_BUCKET/cucumber-json --recursive; fi
artifacts:
  files:
    - '**/*'
cache:
  paths:
    - NVA-end-to-end-testing-test-deploy/node_modules/**/*
